# はかったけ（測っ丈） TODO チェックリスト v1.0

作成日: 2025-09-30

> 実装者が**そのままチェック**できるように、P0/P1/P2で優先度を示し、実行順に近い並びで記載。各項は完了時にチェックしてください。

---

## 0. 事前準備 / 環境（P0）

- [ ] Node.js 20.x をインストール（LTS）。
- [x] パッケージマネージャを選定して固定（`pnpm` 推奨）。
- [x] Android/Chrome 最新端末を準備（HD/FHD/WQHD の少なくとも1機種）。
- [ ] iOS/Safari 参考端末（任意）を準備。
- [x] Vercel アカウント作成/権限確認（プロジェクト作成可）。
- [x] リポジトリ可視性/ライセンス/ブランチ保護ルールを決定。

## 1. リポジトリ初期化（P0）

- [x] Vite + React + TypeScript で雛形生成（`pnpm create vite@latest`）。
- [x] ESLint + Prettier 設定、`tsconfig.json` 厳格化（`strict: true`）。
- [x] `src/` のディレクトリを仕様の構成に合わせて作成。
- [x] Zustand / Three.js / @types/webxr を追加インストール。
- [x] テスト環境: Jest + Testing Library、E2E: Playwright を導入。
- [x] GitHub Actions で CI（lint / type-check / unit / e2e）を追加。（E2Eテストは未実装）
- [ ] Vercel にプロジェクト連携（main ブランチ → Production / PR → Preview）。

## 2. ベース実装（P0）

- [x] ルーティング: トップ（モード選択）/計測/成長記録の 3 画面。
- [x] グローバル状態（Zustand）骨格: `measureMode`, `scale`, `error`。
- [x] 環境判定: `isWebXRAvailable()` 実装と分岐（AR/フォールバック）。
- [x] UI コンポーネント: ボタン、トースト、ダイアログ、タブ。 (タブ完了)

## 3. core/camera（P0）

- [x] `getUserMedia` 取得、権限拒否時のエラー分類（`CAMERA_DENIED`）。
- [x] ストリーム開始/停止 API、画面回転・向き固定対応。

## 4. core/ar（P0）

- [x] WebXR セッション開始/終了 (`startXrSession`)、ヒットテスト初期化 (`initHitTestSource`)。
- [x] WebXRセッション開始時のエラーメッセージ詳細化とユーザーフィードバックの実装。
- [x] レイキャストによる 3D 点取得（`get3dPointFromHitTest`）。
- [x] 平面未検出時のガイド表示（`detectPlane`）。
- [x] ノイズ対策（`stabilizePoint`）で座標安定化。

## 5. core/fallback（P0）

- [x] 写真キャプチャ（最低 1080px の長辺）。
- [x] 2点タップ UI と画像座標の取得。
- [x] 射影変換の下準備（単一フレームでの処理）。

## 6. core/reference（P0→P1）

- [x] 基準物クラス定義（A4/クレカ/硬貨/紙幣）。
- [x] 形状検出（矩形/円）とフィルタリング。
- [x] 実寸テーブル実装（mm）。
- [x] スケール推定（mm/px）と `confidence` 計算。
- [x] 信頼度しきい値 / ユーザー確認ダイアログ（「補正に使う？」）。
- [x] 失敗時の再撮影/ヒント文言。

## 7. core/measure（P0）

- [x] 3D 距離計算（WebXR）。
- [x] 2D 距離計算（フォールバック、スケール適用）。
- [x] 単位換算と小数1桁丸め（内部は mm）。
- [x] 最大距離 10m ガード（超過時は2点目拒否）。

## 8. core/render（P0）

- [x] 計測線（端点円/ライン）描画。
- [x] 数値ラベル（背景輝度に応じて黒/白切替）。
- [x] リフレッシュレート監視（24fps 目標）。

## 9. features: 計測モード（家具・部屋）（P0）

- [x] 2点タップ→距離算出→オーバーレイ表示。
- [x] 単位切替（cm/m）。
- [x] 新規計測で既存線をクリア（常に1本）。
- [x] 保存 UI は**非表示**。

## 10. features: 成長記録モード（P0）

- [x] サブタブ: 身長/足/手/体重（体重は数値入力）。
- [x] 計測（身長/足/手）フローは計測モードと同様。
- [x] 画像合成（計測線/数値/日付）→ `toBlob`（JPEG 0.92）。
- [x] ファイル名生成: `hakattake_YYYY-MM-DD_[項目]_[数値+単位].jpg`。
- [x] 端末ギャラリーへの保存（File System Access / download フォールバック）。
- [x] 自動保存のトースト通知。

## 11. エラーハンドリング（P0）

- [x] エラー型 `ErrorState` 実装（code/message）。
- [x] カメラ拒否 → 再試行導線/設定案内。
- [x] WebXR 非対応/失敗 → フォールバック自動切替 (`handleWebXRFallback`)。
- [x] 平面未検出 → ガイド表示/露出ヒント (`getPlaneDetectionMessage`)。
- [x] 保存失敗 → 画像品質/解像度を下げて再試行 (`saveImageWithRetry`)。
- [x] 基準物検出失敗 → ヒント/再撮影導線 (`getReferenceObjectDetectionMessage`)。
- [x] 例外は ErrorBoundary + 各 core で捕捉、ユーザーへはダイアログ/トースト (`ErrorBoundary`)。
- [x] `src/core/utils/exifUtils.test.ts` の `FileReader` モック化に関するテスト失敗の解消。
- [x] `src/app/GrowthMeasurementTabContent.tsx` の `useCallback` 依存関係の警告解消。

## 12. アクセシビリティ/UX（P1）

- [x] フォントサイズ相対単位（ユーザー設定を尊重）。
- [x] 高コントラスト（黒/白自動切替）。
- [x] 触りやすいタップ領域（最低 44px）。
- [x] 注意文言とヒントを常時/状況別に表示 (`getMeasurementHint`)。

## 13. 性能最適化（P1）

- [ ] 初回ロード ≤ 5s（3G 相当、コード分割/遅延読込）。
- [ ] 計測処理で 24fps を維持（描画間引き/`requestAnimationFrame`）。
- [ ] 画像処理の WebWorker 検討（必要に応じて）。
- [ ] opencv.js はオプション（サイズ影響を評価）。

## 14. セキュリティ/プライバシー（P0）

- [ ] 画像/映像は端末内処理のみ（送信なし）を確認。
- [ ] 解析/広告/追跡 SDK を入れないことを確認。
- [ ] パーミッションは最小権限（カメラのみ）。

## 15. データ/型/ユーティリティ（P0）

- [x] TypeScript 型: `MeasurementResult`, `ScaleEstimation`, `MeasureMode`。

- [x] 日付処理（端末ローカル→ISO 変換、手動修正可）。
- [x] Exif/回転補正（必要時）。

- [x] 文字色切替の輝度判定（YUV/HSV の Y）。

## 16. 単体テスト（Jest）（P0）

- [x] 単位変換/丸め（小数1桁）。
- [x] 2D 距離計算とスケール適用。
- [x] ファイル名生成/日付処理。
- [x] スケール推定の一致判定（モック画像/ダミー入力）。
- [x] 最大距離ガードの境界値。

## 17. 結合/E2E テスト（Playwright）（P0）

- [x] 起動→権限拒否→フォールバック確認。
- [ ] AR 端末: 平面検出→2点→表示が小数1桁。
- [ ] フォールバック: A4/硬貨認識→補正→距離表示。
- [ ] 成長記録: 身長計測→画像自動保存→命名規則確認。
- [x] 体重: 入力→小数1桁→保存→トースト表示。
- [ ] E2Eテストの安定化: ARモードのタイムアウト問題を解消（WebXRモックの統一）。
- [ ] 10m 超過エラー、再計測で線が1本のみ維持。

## 18. 端末/環境マトリクス検証（P1）

- [ ] Android/Chrome（HD/FHD/WQHD）。
- [ ] 低速回線（3G）で初回ロード時間計測。
- [ ] iOS/Safari 参考検証（AR 制限の把握）。

## 19. 受入基準（サンプル）（P0）

- [ ] AR で 3m の既知長を ±3cm 以内で再現（5回平均）。
- [ ] A4 補正時、実測 1m を ±10mm 以内で測定。
- [ ] 自動保存画像に数値/日付が正常に重畳される。

## 20. ドキュメント（P1）

- [ ] README にセットアップ/開発/ビルド/テスト/デプロイ手順。
- [ ] FAQ/ヘルプのドラフト（よくある失敗と対処）。
- [ ] 仕様リンク（spec.md / キャンバス）を README から参照。

## 21. CI/CD & 品質ゲート（P1）

- [ ] main ブランチ保護（PR 必須、スカッシュマージ）。
- [ ] Lint/Type/Unit/E2E の全パスをマージ要件に設定。
- [ ] Vercel Preview の自動コメント（URL 記載）。

## 22. リリース（P1）

- [ ] v0.1.0 タグ作成（CHANGELOG 付与）。
- [ ] プロダクション環境へデプロイ（Vercel main）。
- [ ] 受入基準を満たすまでパッチ（v0.1.x）。

## 23. リスクと緩和（確認）（P1）

- [ ] 基準物誤認 → しきい値引上げ、ユーザー確認ダイアログ維持。
- [ ] AR ヒット不安定 → ガイド/平均化/露出アドバイス実装。
- [ ] 保存 API 差異 → 複数フォールバック経路を実装。

## 24. 将来拡張のフック（P2）

- [ ] Feature Flag で PWA/複数線/面積/角度を段階導入。
- [ ] i18n の土台（辞書/キー）を準備。
- [ ] 共有（Web Share Target）を検討。

---

## Definition of Done（プロジェクト完了判定）

- [ ] 主要機能（計測/成長記録）が仕様通り動作しバグ重大度 High が 0。
- [ ] 受入基準（精度/画像保存）が達成。
- [ ] CI/CD が安定稼働（90%+ 成功率、再試行なしで通過）。
- [ ] README/FAQ が最新で新規開発者が 30 分で環境構築可能。
